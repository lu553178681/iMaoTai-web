# 多商品选择功能修复指南

## 问题描述

在使用多商品选择功能时，系统出现以下错误：

```
ImportError: cannot import name 'MultipleCheckboxField' from 'wtforms'
```

这是因为 WTForms 库中实际上没有 `MultipleCheckboxField` 这个类，需要我们自定义。

## 解决方案

### 方案一：运行修复脚本（推荐）

1. 运行提供的修复脚本：

```bash
python fix_wtforms.py
```

2. 重启应用：

```bash
python app.py
```

### 方案二：手动修改代码

如果修复脚本无法正常工作，可以按照以下步骤手动修改：

1. 打开 `app.py` 文件
2. 找到导入语句：
   ```python
   from wtforms import StringField, PasswordField, SubmitField, SelectField, BooleanField, TimeField, HiddenField, TextAreaField, MultipleCheckboxField
   ```

3. 修改为：
   ```python
   from wtforms import StringField, PasswordField, SubmitField, SelectField, BooleanField, TimeField, HiddenField, TextAreaField, SelectMultipleField, widgets
   ```

4. 在 Flask 应用创建后、模型定义前添加以下代码：
   ```python
   # 创建自定义多选字段
   class MultipleCheckboxField(SelectMultipleField):
       """
       自定义多选字段，渲染为一组复选框
       """
       widget = widgets.ListWidget(prefix_label=False)
       option_widget = widgets.CheckboxInput()
   ```

## 数据库迁移（可选）

为更好地支持多商品预约，建议运行数据库迁移脚本：

```bash
python migrate_multi_items.py
```

这将在数据库中创建一个新表，用于存储任务与商品的多对多关系。

## 检验修复是否生效

1. 重启应用后，打开「创建预约」页面，确认可以勾选多个商品
2. 创建一个测试预约，选择多个商品提交
3. 查看「我的预约」页面，确认所有选择的商品都已被成功预约

## 常见问题

### Q: 修复后仍然出现导入错误

确保您的 WTForms 版本支持 `SelectMultipleField` 和 `widgets`。如果使用的是较旧版本，可以尝试升级：

```bash
pip install --upgrade wtforms
```

### Q: 迁移脚本运行出错

检查数据库文件是否存在及权限问题。如果数据库已有大量数据，建议先备份：

```bash
cp instance/site.db instance/site.db.bak
```

### Q: 选择多个商品后提交失败

检查表单验证逻辑，确保服务器端正确处理了多选字段的数据。

## 技术支持

如遇到其他问题，请提供详细的错误信息和环境配置，方便我们更好地帮助您解决问题。 